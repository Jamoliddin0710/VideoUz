<div class="container py-5">

    <div class="card">
        <div class="card-header">
            <h2 class="mb-0"><i class="fas fa-th-list me-2"></i>Categories</h2>
            <button type="button" class="btn btn-primary actions" onclick="createRecord()">
                <i class="fas fa-plus me-2"></i>Create
            </button>
            <div class="flex box">
                <div class="flex-1">
                    <select class="form-input" name="searchBy">
                        @foreach (var field in ViewBag.SearchFields)
                        {
                            if (field.Key == ViewBag.searchBy)
                            {
                                <option selected="selected" value="@field.Key"> @field.Value</option>
                            }
                            else
                            {
                                <option value="@field.Key"> @field.Value</option>
                            }
                        }
                    </select>
                </div>
                <div class="flex-1">
                    <input type="search" class="form-input" placeholder="Search" name="searchString" value="@ViewBag.SearchString"/>
                </div>
                <div class="flex-1">
                    <input type="submit" class="button button-blue-back" value="Search"/>
                    <a href="~/persons/index" class="link-hover" style="text-decoration: none">Clear all</a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                    <tr>
                        <td width="10%">Id</td>
                        <td width="30%">Name</td>
                        <td width="40%">Description</td>
                        <td width="20%">Actions</td>
                    </tr>
                    </thead>
                    <tbody id="categories">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



<script>
    $( document ).ready(function() {
        getCategories();
    });
    
    function getCategories(){
        $.ajax({
            url : "@Url.Action("GetAllCategories", "Admin")",
            type:"GET",
            success: function (data){

                if (data.isSuccess){
                    $('#categories').empty();
                    data.result.map((item,  index) => {
                        const row = `<tr id="trid_${index}"> 
                             <td> ${index} </td> 
                              </tr>`
                        $('#categories').append(row);
                        displaytablerow("display", index, item.id, item.name, item.description);
                    });
                }
                else {
                    toastr.options = {
                        "positionClass": "toast-top-right",
                        "timeOut": "3000",
                        "closeButton": true,
                        "progressBar": true
                    };
                    toastr.error(` ${xhr.status} - ${data.message}`);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.options = {
                    "positionClass": "toast-top-right",
                    "timeOut": "3000",
                    "closeButton": true,
                    "progressBar": true
                };
                toastr.error(` ${xhr.status} - ${thrownError}`, "So'rov bajarilmadi");
            }
        })
    }

    function displaytablerow(mode, index, id, name, description) {
        $('#trid_' + index).empty();
        let innerHtml = "";
        innerHtml += `<td><span class="badge bg-secondary">${id}</span></td>`;
        if (mode == 'display'){
            $('.actions').prop('disabled', false);
            innerHtml += `<td>`;
            innerHtml += `<input id="input_${index}" type="text" value="${name}" class="form-control" disabled>`;
            innerHtml += `</td>`;
            innerHtml += `<td>`;
            innerHtml += `<input id="input_description${index}" type="text" value="${description}" class="form-control" disabled>`;
            innerHtml += `</td>`;
            innerHtml += `<td>`;
            innerHtml += `<button onclick="displaytablerow('edit', ${index}, ${id}, '${name}', '${description}')" class="btn btn-warning text-white me-2 action-btn actions"><i class="fas fa-edit"></i> Edit</button>`;
            innerHtml += `<button onclick="deleteRecord(${id})" class="btn btn-danger text-white action-btn actions"><i class="fas fa-trash-alt"></i> Delete</button>`;
            innerHtml += `</td>`;
        }
        else if(mode == 'edit'){
            $('.actions').prop('disabled', true);
            innerHtml += `<td>`;
            innerHtml += `<input id="input_${index}" type="text" value="${name}" class="form-control">`;
            innerHtml += `</td>`;
            innerHtml += `<td>`;
            innerHtml += `<input id="input_description${index}" type="text" value="${description}" class="form-control">`;
            innerHtml += `</td>`;
            innerHtml += `<td>`;
            innerHtml += `<button onclick="save(${index}, ${id})" class="btn btn-success text-white me-2 action-btn"><i class="fas fa-save"></i> Save</button>`;
            innerHtml += `<button onclick="displaytablerow('display', ${index}, ${id}, '${name}', '${description}')" class="btn btn-warning text-white action-btn"><i class="fas fa-times"></i> Cancel</button>`;
            innerHtml += `</td>`;
        }
        console.log('#trId_' + index);
        $('#trid_' + index).append(innerHtml);
    }

    function createRecord(){
        $('.actions').prop('disabled', false);
        let index = $('#categories tr').length;
        let innerHtml = '';
        innerHtml += `<tr id="trid_${index}">`;
        innerHtml += `<td><span class="badge bg-info">${index + 1}</span></td>`;
        innerHtml += `<td>`;
        innerHtml += `<input id="input_${index}" type="text" class="form-control" placeholder="Enter name">`;
        innerHtml += `<span id="validationTextId_${index}" class="text-danger"></span>`;
        innerHtml += `</td>`;
        innerHtml += `<td>`;
        innerHtml += `<input id="input_description${index}" type="text" class="form-control" placeholder="Enter description">`;
        innerHtml += `<span id="validationTextId_description${index}" class="text-danger"></span>`;
        innerHtml += `</td>`;
        innerHtml += `<td id="tdActionId_${index}"></td>`;
        innerHtml += `</tr>`;
        $('#categories').append(innerHtml);
        const $tdactionid = $('#tdActionId_'+ index);
        let saveButton = `<button onclick="save(${index}, ${0})" class="btn btn-success text-white me-2 action-btn"><i class="fas fa-save"></i> Save</button>`;
        let cancelButton = `<button onclick="getCategories()" class="btn btn-warning text-white action-btn"><i class="fas fa-times"></i> Cancel</button>`;
        $tdactionid.append(saveButton, cancelButton);
    }

  async function deleteRecord(Id) {
        let result = await confirmation('Are you sure you want to delete this category?');
        if (result){
            $.ajax({
                url: '@Url.Action("Delete", "Admin")' + '?id=' + Id,
                type: 'DELETE',
                success: function (response) {
                    getCategories();
                    displaynotification(response.isSuccess, response.title, response.message, 'modal');
                },
                error: function (xhr, status, error) {
                    displaynotification(false, response.title, response.message, 'modal');
                }
            });
        }
    }

    function save(index, id) {
        const name = $('#input_' + index).val();
        const description = $('#input_description' + index).val();

        // Validation
        let isValid = true;

        if (!name) {
            $('#validationTextId_' + index).text('Name is required');
            isValid = false;
        } else {
            $('#validationTextId_' + index).text('');
        }

        if (!isValid) return;

        let model = {
            id,
            name,
            description
        };

        $.ajax({
            url: "@Url.Action("AddorEditCategory")",
            type: 'POST',
            contentType: 'application/json', 
            data: JSON.stringify(model),
            success(response) {
                toastr.options = {
                    "positionClass": "toast-top-right",
                    "timeOut": "3000",
                    "closeButton": true,
                    "progressBar": true
                };
                getCategories();
                displaynotification(response.isSuccess, response.title, response.message, 'toastr');
            },
            error: function (xhr, ajaxOptions, thrownError) {
                toastr.options = {
                    "positionClass": "toast-top-right",
                    "timeOut": "3000",
                    "closeButton": true,
                    "progressBar": true
                };
                displaynotification(false, xhr, thrownError, 'toastr');
            }
        });
    }

    function displaynotification(isSuccess, title, message, type) {
        if (type === 'toastr') {
            if (isSuccess) {
                toastr.success(message, title);
            } else {
                toastr.error(message, title);
            }
        }
    }

</script>


<style>

    .box
    {
        margin: 10px 20px;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #d3d1d1;
        box-shadow: 0px 0px 3px 2px #ffffff;
    }
    .form-input
    {
        padding: 8px 10px;
        font-size: 105%;
        border-radius: 8px;
        border: 1px solid #d0d0d0;
        width: 100%;
        transition: box-shadow 0.2s;
    }
    .flex-1
    {
        flex: 1 auto;
    }
    
    .flex
    {
        display: flex;
        flex-wrap: wrap;
        align-content: stretch;
        align-items: stretch;
    }
    
    :root {
        --primary-color: #3498db;
        --secondary-color: #2c3e50;
        --success-color: #2ecc71;
        --danger-color: #e74c3c;
        --warning-color: #f39c12;
    }

    body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .card {
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: none;
        margin-bottom: 25px;
    }

    .card-header {
        background-color: var(--secondary-color);
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 15px 20px;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        border-radius: 6px;
        padding: 8px 20px;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-primary:hover {
        background-color: #2980b9;
        border-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-success {
        background-color: var(--success-color);
        border-color: var(--success-color);
        border-radius: 6px;
    }

    .btn-warning {
        background-color: var(--warning-color);
        border-color: var(--warning-color);
        border-radius: 6px;
    }

    .btn-danger {
        background-color: var(--danger-color);
        border-color: var(--danger-color);
        border-radius: 6px;
    }

    .table {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .table thead {
        background-color: var(--secondary-color);
        color: white;
    }

    .table thead td {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 15px;
        vertical-align: middle;
    }

    .table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    .table tbody tr:hover {
        background-color: #e9f0f5;
    }

    .table td {
        padding: 15px;
        vertical-align: middle;
    }

    .form-control {
        border-radius: 6px;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
    }

    .form-control:focus {
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
        border-color: var(--primary-color);
    }

    .action-btn {
        padding: 6px 12px;
        margin-right: 5px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .action-btn i {
        margin-right: 5px;
    }

    .badge {
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: 500;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .toast {
        animation: fadeIn 0.3s ease-out forwards;
    }
</style>
